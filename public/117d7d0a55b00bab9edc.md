---
title: Laravel + GCS ã§storageç®¡ç†ã—ã¦ã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’CGSã§ç®¡ç†ã™ã‚‹ã‚ˆã†ã«ã—ãŸæ™‚ã®å‚™å¿˜éŒ²
tags:
  - Laravel
  - GCS
private: false
updated_at: '2022-03-01T20:43:45+09:00'
id: 117d7d0a55b00bab9edc
organization_url_name: null
slide: false
ignorePublish: false
---
# ã¯ã˜ã‚ã«
ã“ã®è¨˜äº‹ã§ã¯Laravelã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’GCSã§ç®¡ç†ã—ãŸæ™‚ã®å‚™å¿˜éŒ²ã§ã™

# ã‚„ã‚Šæ–¹

## äº‹å‰æº–å‚™:GCPã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒã‚±ãƒƒãƒˆã®ä½œæˆ

ä»¥ä¸‹ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸğŸ™‡â€â™‚ï¸

https://blog.capilano-fw.com/?p=3359

## ä½œæˆã—ãŸ`Storage`ã«ä»¥ä¸‹ã®æ¨©é™ã‚’ä»˜ä¸ã—ã¦ãŠã

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-13 16.31.51.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/73b6b849-f3d6-18be-9312-39705b6fe402.png)


## `.env`ã«ç™»éŒ²ã—ãŸãƒã‚±ãƒƒãƒˆåã‚’å…¥åŠ›ã™ã‚‹

```text:.env
GCS_BUCKET_NAME="hoge-bucket"
```

## `.env`ã®å€¤ã‚’`app.php`ã‹ã‚‰å‚ç…§ã™ã‚‹

```php:src/laravel/config/app.php
'gcp_bucket_name' => env('GCS_BUCKET_NAME', 'hoge-bucket'),
```

## GCSã‚’æ“ä½œã™ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
composer require google/cloud-storage
```

https://packagist.org/packages/google/cloud-storage

https://googleapis.github.io/google-cloud-php/#/

## google/cloud-storageã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã™ã‚‹

- äº‹å‰æº–å‚™ã§ä½œæˆã—ãŸãƒã‚±ãƒƒãƒˆã®èªè¨¼ã‚­ãƒ¼ã‚’`storage`ç›´ä¸‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™


`Config('app.gcp_bucket_name');`:`app.php`ã‹ã‚‰ãƒã‚±ãƒƒãƒˆåã‚’å‚ç…§ã—ã¾ã™

`$url = file_get_contents()`:äº‹å‰æº–å‚™ã§ä½œæˆã—ãŸã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¾ã™

`new StorageClient([ãƒã‚±ãƒƒãƒˆå,ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«])`:

`$client->bucket();`:ãƒã‚±ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¾ã™

```php:src/laravel/app/Services/Utilities/UtilityService.php
class UtilityService
{

    public $bucket;
    public $bucketOptions;

    public function __construct()
    {
        $projectId = Config('app.gcp_bucket_name');
        $url = file_get_contents(storage_path('app/local-service-account.json', true));

        $client = new StorageClient([
            'projectId' => $projectId,
            'keyFile' => json_decode($url, true)
        ]);
        $this->bucket = $client->bucket($projectId);
        $this->bucketOptions = [
            'resumable' => true, // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å†é–‹å¯èƒ½ã«è¡Œã†ã‹
            'name' => '',
            'metadata' => [
                // æ—¥æœ¬èªåŒ–
                'contentLanguage' => 'ja'
            ]
        ];
    }

    /**
     * ä»®ç™»éŒ²GCSä¿å­˜åã‚’ä½œæˆ
     *
     * @param UploadedFile $file
     * @param string $dirName
     * @param string $uniqueKey
     * @param array $options
     * @return array
     */
    public function setBucketOptions(UploadedFile $file, string $dirName, string $uniqueKey, array $options): array {
        $extension = $file->extension();
        $fileName = "{$uniqueKey}_{$dirName}.{$extension}";

        // ä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç”Ÿæˆ
        $options['name'] = "tmp/images/{$uniqueKey}/{$dirName}/{$fileName}";
        return $options;
    }
}
```

## é€ä¿¡æ™‚ã«GCSã«ä¸€æ™‚ä¿å­˜ã™ã‚‹

`tmp/images/ä¸€æ„ãªå€¤`ã«ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™

```php:src/laravel/app/Services/SkillSheet/SkillSheetService.php
protected UtilityService $utilityService;

public function __construct()
{
    $this->utilityService = new UtilityService();
}
/**
 * GCSã¸ã®ä»®ä¿å­˜
 *
 * @param StoreSkillSheetRequest $request
 * @param string $uniqueKey
 * @return array
 */
public function tmpStorageToGcsBucket(StoreSkillSheetRequest $request, string $uniqueKey): array
{
    // ãƒã‚±ãƒƒãƒˆã‚’ç”Ÿæˆ
    $bucket = $this->utilityService->bucket;

    // ç™»éŒ²ã—ãŸä¿å­˜åã‚’ä¿æŒã—ã¦ã„ã
    $saveNames = [];

    // å†™çœŸãƒ»å‹•ç”»ãƒ»ãã®ä»–ç”»åƒã‚’ï¼‘ä»¶ãšã¤æŒ¯ã‚Šåˆ†ã‘ã™ã‚‹
    foreach ($request->file() as $key => $files) {
        foreach ($files as $file) {
            $options = $this->utilityService->setBucketOptions(
                $file,
                $key,
                $uniqueKey,
                $this->utilityService->bucketOptions
            );

            $saveNames[$key] = $options['name'];

            $bucket->upload(
                fopen($file, 'rb'),
                $options
            );
        }
    }

    return $saveNames;
}
```

## GCSã«ä¸€æ™‚ä¿å­˜ã—ãŸç”»åƒã‚’æ­£å¼ã«ä¿å­˜ã™ã‚‹å ´æ‰€ã«ç§»å‹•ã—ã¾ã™

`images/ä¸€æ„ãªå€¤ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ID`ã«ä¿å­˜ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¸€æ™‚ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒã—ã¦ã„ã‚‹çŠ¶æ…‹ã¨ä»®å®šã—ã¾ã™

```php:
/**
 * GCSä¿å­˜
 *
 * @param integer $id
 * @param SkillSheet $target
 * @param array $updSkillSheet
 * @return array
 */
public
function storageToGcsBucket(int $id, SkillSheet $target, array $updSkillSheet): array
{
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„ã™ã‚‹
    $saveNames = Session('saveNames');
    session()->forget('saveNames');

    // ãƒã‚±ãƒƒãƒˆã‚¤ãƒ‹ã‚·ãƒ£ãƒ©ã‚¤ã‚º
    $bucket = $this->utilityService->bucket;

    // ä»®ç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç§»å‹•ã•ã›ã¦ã‹ã‚‰å‰Šé™¤ã™ã‚‹
    foreach ($saveNames as $key => $v) {
        // ä»®ç™»éŒ²ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãƒã‚±ãƒƒãƒˆã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ç§»ç®¡ã™ã‚‹
        $targetObject = $bucket->object($v);
        $extension = pathinfo($v)['extension'];
        $name = "skill_sheet/{$id}/{$key}/{$id}_{$key}.{$extension}";

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ä»®ç½®ãã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ç§»å‹•ã™ã‚‹ãƒ»ä»®ç½®ãã¯å‰Šé™¤ã™ã‚‹
        if ($targetObject->exists()) {
            $targetObject->copy($bucket, ['name' => $name]);
            $targetObject->delete();
        }

        // ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯å·®ã—æ›¿ãˆã‚‹(æ›´æ–°)
        if ($target->pr_image_path) {
            // å·®ã—æ›¿ãˆå‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—
            $beforeObject = $bucket->object($target->pr_image_path);

            // å·®ã—æ›¿ãˆå‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
            if ($beforeObject->exists()) {
                $beforeObject->delete();
            } else {
                // å·®ã—æ›¿ãˆå‰ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒãªã„ã®ã«DBã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒªã‚»ãƒƒãƒˆã™ã‚‹
                $updSkillSheet['pr_image_path'] = null;
            }
        }
        $updSkillSheet['pr_image_path'] = $name;
    }

    return $updSkillSheet;
}
```

## ç§»å‹•å…ˆã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿä½“ãŒç§»å‹•ã•ã‚Œã¾ã™

![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2022-01-02 21.31.33.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/555632/bd655655-e750-72c4-5327-0fe7d03535b8.png)
